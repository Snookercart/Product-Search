<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Search</title>
<style>
  #searchBox {
    padding: 11px;
    width: 100%;
    font-size: 16px;
    color: maroon;
    font-weight: bold;
    max-width: 300px;
    border: 2px solid #D9913E;
    border-radius: 10px;
  }
  #suggestions li:hover {
    background-color: #f8e4d0;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- Search Input -->
<input type="text" id="searchBox" placeholder="Search Products...">
<ul id="suggestions" style="list-style:none; padding:0; margin-top:10px;"></ul>

<!-- Load products from GitHub with error handling -->
<script>
  let script = document.createElement('script');
  script.src = "https://snookercart.github.io/Product-Search/search.js";
  script.onload = () => console.log("✅ Products loaded successfully from GitHub Pages.");
  script.onerror = () => {
    console.error("❌ Failed to load products from GitHub Pages. Check URL or repo settings.");
    document.getElementById('suggestions').innerHTML = '<li style="padding:8px; color:red;">Error loading products. Please try again later.</li>';
  };
  document.head.appendChild(script);
</script>

<script>
  let currentIndex = -1;
  let filtered = [];

  function highlightMatch(name, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return name.replace(regex, '<strong style="color: maroon;">$1</strong>');
  }

  function renderSuggestions() {
    const suggestionBox = document.getElementById('suggestions');
    suggestionBox.innerHTML = '';
    filtered.forEach((p, index) => {
      const li = document.createElement('li');
      li.innerHTML = `<a href="${p.url}" target="_blank" style="color: chocolate; text-decoration: none; display: block; padding: 8px;">${highlightMatch(p.name, document.getElementById('searchBox').value)}</a>`;
      li.addEventListener('mouseover', () => {
        currentIndex = index;
        updateHighlight();
      });
      suggestionBox.appendChild(li);
    });
    updateHighlight();
  }

  function updateHighlight() {
    const suggestionBox = document.getElementById('suggestions');
    Array.from(suggestionBox.children).forEach((li, idx) => {
      li.style.backgroundColor = idx === currentIndex ? '#f8e4d0' : '';
    });
  }

  function searchProducts(e) {
    const input = document.getElementById('searchBox').value.trim().toLowerCase();

    if (e.key === 'ArrowDown') {
      if (filtered.length > 0) {
        currentIndex = (currentIndex + 1) % filtered.length;
        updateHighlight();
      }
      return;
    }

    if (e.key === 'ArrowUp') {
      if (filtered.length > 0) {
        currentIndex = (currentIndex - 1 + filtered.length) % filtered.length;
        updateHighlight();
      }
      return;
    }

    if (e.key === 'Enter') {
      if (currentIndex >= 0 && filtered[currentIndex]) {
        window.open(filtered[currentIndex].url, '_blank');
      } else if (filtered.length > 0) {
        window.open(filtered[0].url, '_blank');
      }
      return;
    }

    currentIndex = -1;
    if (!input) {
      document.getElementById('suggestions').innerHTML = '';
      filtered = [];
      return;
    }

    if (typeof products === 'undefined') {
      document.getElementById('suggestions').innerHTML = '<li style="padding:8px; color:red;">Products not loaded. Check connection.</li>';
      return;
    }

    filtered = products.filter(p => p.name.toLowerCase().includes(input));

    if (filtered.length === 0) {
      document.getElementById('suggestions').innerHTML = '<li style="padding:8px; color:gray;">No matching products found.</li>';
      return;
    }

    renderSuggestions();
  }

  function initSearch() {
    if (typeof products !== 'undefined') {
      document.getElementById('searchBox').addEventListener('keydown', searchProducts);
    } else {
      setTimeout(initSearch, 200);
    }
  }
  initSearch();
</script>

</body>
</html>
